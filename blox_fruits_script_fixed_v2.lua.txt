-- ENCHANTED HUB | BLOX FRUITS
-- Made by xX_ProGamer_Xx 
-- FIXED: M1 attacks now hit, hitbox expands, and position is above monsters!

if not game:IsLoaded() then 
    repeat game.Loaded:Wait()
    until game:IsLoaded() 
end

-- Team selection
repeat wait()
    if game:GetService("Players").LocalPlayer.PlayerGui.Main:FindFirstChild("ChooseTeam") then
        if game:GetService("Players").LocalPlayer.PlayerGui.Main.ChooseTeam.Visible == true then
            for i,v in pairs(getconnections(game:GetService("Players").LocalPlayer.PlayerGui.Main.ChooseTeam.Container.Pirates.Frame.ViewportFrame.TextButton.MouseButton1Click)) do
                v.Function()
            end
        end
    end
until game.Players.LocalPlayer.Neutral == false

wait(1)

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local VirtualUser = game:GetService("VirtualUser")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")

-- Anti-AFK
game:service'Players'.LocalPlayer.Idled:connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

-- Settings
_G.Settings = {
    AutoFarm = false,
    AutoQuest = false,
    BringMobs = false,
    FastAttack = false,
    AutoHaki = false,
    SelectWeapon = ""
}

_G.AttackEnabled = false
_G.FastAttack = false

-- Proper M1 attack logic (always fires at mobs, with hitbox range fix)
local function ValidTarget(mon)
    return mon and mon:FindFirstChild("Humanoid") and mon.Humanoid.Health > 0 and mon:FindFirstChild("HumanoidRootPart")
end

local function GetClosestMob()
    local closest, dist = nil, math.huge
    for _, v in pairs(Workspace.Enemies:GetChildren()) do
        if ValidTarget(v) then
            local d = (HumanoidRootPart.Position - v.HumanoidRootPart.Position).Magnitude
            if d < dist then
                closest = v
                dist = d
            end
        end
    end
    return closest
end

spawn(function()
    while wait() do
        if _G.AttackEnabled and _G.FastAttack then
            pcall(function()
                -- Always attack at the position of the closest mob (above its head)
                local mob = GetClosestMob()
                if mob then
                    -- Teleport the player directly above the mob (not behind)
                    HumanoidRootPart.CFrame = mob.HumanoidRootPart.CFrame * CFrame.new(0, 5, 0)
                    -- Expand mob hitbox (fix hit register)
                    mob.HumanoidRootPart.Size = Vector3.new(150, 150, 150)
                    mob.HumanoidRootPart.Transparency = 1
                    mob.HumanoidRootPart.CanCollide = false
                    -- Attack logic
                    local tool = Character:FindFirstChildOfClass("Tool")
                    if tool then
                        tool:Activate()
                    end
                    -- VirtualUser method (for best hit registration)
                    VirtualUser:CaptureController()
                    VirtualUser:Button1Down(Vector2.new(1280, 672))
                    wait(0.01)
                    VirtualUser:Button1Up(Vector2.new(1280, 672))
                end
            end)
        end
        wait(0.02)
    end
end)

-- BringMobs fix: teleport mobs to slightly below player for stacking, only those for the quest
local function BringMobs()
    if not _G.Settings.BringMobs then return end
    local mobName = QuestData.MonsterName
    for _, v in pairs(Workspace.Enemies:GetChildren()) do
        if ValidTarget(v) and v.Name==mobName then
            -- Remove previous velocity
            for _, child in ipairs(v.HumanoidRootPart:GetChildren()) do
                if child:IsA("BodyVelocity") or child:IsA("BodyPosition") or child:IsA("BodyAngularVelocity") then
                    child:Destroy()
                end
            end
            -- Expand hitbox for easier farming
            v.HumanoidRootPart.Size = Vector3.new(150,150,150)
            v.HumanoidRootPart.Transparency = 1
            v.HumanoidRootPart.CanCollide = false
            -- Teleport mob just below player to avoid stacking errors
            v.HumanoidRootPart.CFrame = HumanoidRootPart.CFrame * CFrame.new(0,-3,0)
            v.Humanoid.WalkSpeed = 0
            v.Humanoid.JumpPower = 0
            v.Humanoid.PlatformStand = true
            v.Humanoid.Sit = true
            -- Freeze mob in place
            local bv = Instance.new("BodyVelocity")
            bv.MaxForce = Vector3.new(1e9,1e9,1e9)
            bv.Velocity = Vector3.new(0,0,0)
            bv.Parent = v.HumanoidRootPart
        end
    end
end

-- Quest Data
QuestData = {}

local function CheckQuest()
    local level = LocalPlayer.Data.Level.Value

    if level >= 1 and level <= 9 then
        QuestData.MonsterName = "Bandit"
        QuestData.QuestName = "BanditQuest1"
        QuestData.QuestNum = 1
        QuestData.QuestGiver = CFrame.new(1060.93835, 16.4550667, 1547.78418)
        QuestData.MonsterSpawn = CFrame.new(1145, 17, 1634)
    elseif level >= 10 and level <= 14 then
        QuestData.MonsterName = "Monkey"
        QuestData.QuestName = "JungleQuest"
        QuestData.QuestNum = 1
        QuestData.QuestGiver = CFrame.new(-1598.08911, 35.5501175, 153.377838)
        QuestData.MonsterSpawn = CFrame.new(-1448, 50, 63)
    elseif level >= 15 and level <= 29 then
        QuestData.MonsterName = "Gorilla"
        QuestData.QuestName = "JungleQuest"
        QuestData.QuestNum = 2
        QuestData.QuestGiver = CFrame.new(-1598.08911, 35.5501175, 153.377838)
        QuestData.MonsterSpawn = CFrame.new(-1129, 40, -515)
    elseif level >= 30 and level <= 39 then
        QuestData.MonsterName = "Pirate"
        QuestData.QuestName = "BuggyQuest1"
        QuestData.QuestNum = 1
        QuestData.QuestGiver = CFrame.new(-1140.27002, 4.75205183, 3827.5498)
        QuestData.MonsterSpawn = CFrame.new(-1201, 40, 3857)
    elseif level >= 40 and level <= 59 then
        QuestData.MonsterName = "Brute"
        QuestData.QuestName = "BuggyQuest1"
        QuestData.QuestNum = 2
        QuestData.QuestGiver = CFrame.new(-1140.27002, 4.75205183, 3827.5498)
        QuestData.MonsterSpawn = CFrame.new(-1387, 87, 4100)
    elseif level >= 60 and level <= 74 then
        QuestData.MonsterName = "Desert Bandit"
        QuestData.QuestName = "DesertQuest"
        QuestData.QuestNum = 1
        QuestData.QuestGiver = CFrame.new(894.488647, 5.14000702, 4392.43359)
        QuestData.MonsterSpawn = CFrame.new(932, 7, 4484)
    elseif level >= 75 and level <= 89 then
        QuestData.MonsterName = "Desert Officer"
        QuestData.QuestName = "DesertQuest"
        QuestData.QuestNum = 2
        QuestData.QuestGiver = CFrame.new(894.488647, 5.14000702, 4392.43359)
        QuestData.MonsterSpawn = CFrame.new(1608, 8, 4371)
    elseif level >= 90 and level <= 99 then
        QuestData.MonsterName = "Snow Bandit"
        QuestData.QuestName = "SnowQuest"
        QuestData.QuestNum = 1
        QuestData.QuestGiver = CFrame.new(1389.74451, 88.1519318, -1298.90796)
        QuestData.MonsterSpawn = CFrame.new(1354, 87, -1393)
    elseif level >= 100 and level <= 119 then
        QuestData.MonsterName = "Snowman"
        QuestData.QuestName = "SnowQuest"
        QuestData.QuestNum = 2
        QuestData.QuestGiver = CFrame.new(1389.74451, 88.1519318, -1298.90796)
        QuestData.MonsterSpawn = CFrame.new(1201, 400, -1404)
    elseif level >= 120 and level <= 149 then
        QuestData.MonsterName = "Chief Petty Officer"
        QuestData.QuestName = "MarineQuest2"
        QuestData.QuestNum = 1
        QuestData.QuestGiver = CFrame.new(-5039.58643, 27.3500385, 4324.68018)
        QuestData.MonsterSpawn = CFrame.new(-4881, 22, 4273)
    elseif level >= 150 and level <= 174 then
        QuestData.MonsterName = "Sky Bandit"
        QuestData.QuestName = "SkyQuest"
        QuestData.QuestNum = 1
        QuestData.QuestGiver = CFrame.new(-4839.53027, 716.368591, -2619.44165)
        QuestData.MonsterSpawn = CFrame.new(-4953, 295, -2899)
    else
        QuestData.MonsterName = "Bandit"
        QuestData.QuestName = "BanditQuest1"
        QuestData.QuestNum = 1
        QuestData.QuestGiver = CFrame.new(1060.93835, 16.4550667, 1547.78418)
        QuestData.MonsterSpawn = CFrame.new(1145, 17, 1634)
    end
end

-- Equip Weapon
local function EquipWeapon()
    for _, tool in pairs(LocalPlayer.Backpack:GetChildren()) do
        if tool:IsA("Tool") then
            if _G.Settings.SelectWeapon == "" or tool.Name == _G.Settings.SelectWeapon then
                LocalPlayer.Character.Humanoid:EquipTool(tool)
                return
            end
        end
    end
end

-- Teleport Function
local function Teleport(targetCFrame)
    local distance = (HumanoidRootPart.Position - targetCFrame.Position).Magnitude
    local speed = 300
    local time = distance / speed

    if time > 0.5 then
        local tween = TweenService:Create(HumanoidRootPart, TweenInfo.new(time, Enum.EasingStyle.Linear), {CFrame = targetCFrame})
        tween:Play()
        tween.Completed:Wait()
    else
        HumanoidRootPart.CFrame = targetCFrame
    end
end

-- Take Quest
local function TakeQuest()
    if not _G.Settings.AutoQuest then return end

    CheckQuest()

    local questGui = LocalPlayer.PlayerGui.Main.Quest
    if questGui.Visible then
        local questTitle = questGui.Container.QuestTitle.Title.Text
        if string.find(questTitle, QuestData.MonsterName) then
            return
        end
    end

    Teleport(QuestData.QuestGiver)
    wait(1)
    ReplicatedStorage.Remotes.CommF_:InvokeServer("StartQuest", QuestData.QuestName, QuestData.QuestNum)
    wait(0.5)
end

-- Auto Farm Function
local function AutoFarmFunction()
    while _G.Settings.AutoFarm do
        pcall(function()
            CheckQuest()
            TakeQuest()
            EquipWeapon()

            _G.AttackEnabled = true
            _G.FastAttack = true

            local target = nil
            for _, v in pairs(Workspace.Enemies:GetChildren()) do
                if v.Name == QuestData.MonsterName and ValidTarget(v) then
                    target = v
                    break
                end
            end

            if target then
                -- Bring mobs
                BringMobs()
                -- Go above target
                local targetPos = target.HumanoidRootPart.CFrame * CFrame.new(0, 5, 0)
                HumanoidRootPart.CFrame = targetPos

                while target and target.Parent and target.Humanoid.Health > 0 and _G.Settings.AutoFarm do
                    BringMobs()
                    wait(0.1)
                end
            else
                Teleport(QuestData.MonsterSpawn)
                wait(2)
            end
        end)
        wait(0.1)
    end
    _G.AttackEnabled = false
    _G.FastAttack = false
end

-- Auto Haki
spawn(function()
    while wait(1) do
        if _G.Settings.AutoHaki and Character then
            if not Character:FindFirstChild("HasBuso") then
                ReplicatedStorage.Remotes.CommF_:InvokeServer("Buso")
            end
        end
    end
end)

-- Create Fluent Library GUI
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

local Window = Fluent:CreateWindow({
    Title = "ENCHANTED HUB | Blox Fruits",
    SubTitle = "by xX_ProGamer_Xx",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true,
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.RightControl
})

local Tabs = {
    Main = Window:AddTab({ Title = "Main", Icon = "home" }),
    Combat = Window:AddTab({ Title = "Combat", Icon = "sword" }),
    Misc = Window:AddTab({ Title = "Misc", Icon = "settings" })
}

-- Main Tab
local MainSection = Tabs.Main:AddSection("Auto Farm")

local AutoFarmToggle = Tabs.Main:AddToggle("AutoFarm", {
    Title = "Auto Farm",
    Description = "Automatically farm levels",
    Default = false
})

AutoFarmToggle:OnChanged(function(value)
    _G.Settings.AutoFarm = value
    if value then
        spawn(AutoFarmFunction)
    end
end)

local AutoQuestToggle = Tabs.Main:AddToggle("AutoQuest", {
    Title = "Auto Quest",
    Description = "Automatically take quests",
    Default = false
})

AutoQuestToggle:OnChanged(function(value)
    _G.Settings.AutoQuest = value
end)

local BringMobsToggle = Tabs.Main:AddToggle("BringMobs", {
    Title = "Bring Mobs",
    Description = "Teleport mobs to you",
    Default = false
})

BringMobsToggle:OnChanged(function(value)
    _G.Settings.BringMobs = value
end)

-- Combat Tab
local CombatSection = Tabs.Combat:AddSection("Combat Settings")

local FastAttackToggle = Tabs.Combat:AddToggle("FastAttack", {
    Title = "Fast Attack",
    Description = "High-speed M1 attacks",
    Default = false
})

FastAttackToggle:OnChanged(function(value)
    _G.AttackEnabled = value
    _G.FastAttack = value
end)

local AutoHakiToggle = Tabs.Combat:AddToggle("AutoHaki", {
    Title = "Auto Haki",
    Description = "Automatically use Buso Haki",
    Default = false
})

AutoHakiToggle:OnChanged(function(value)
    _G.Settings.AutoHaki = value
end)

-- Weapon Selection
local weapons = {}
for _, tool in pairs(LocalPlayer.Backpack:GetChildren()) do
    if tool:IsA("Tool") then
        table.insert(weapons, tool.Name)
    end
end

local WeaponDropdown = Tabs.Combat:AddDropdown("WeaponSelect", {
    Title = "Select Weapon",
    Values = weapons,
    Multi = false,
    Default = 1,
})

WeaponDropdown:OnChanged(function(value)
    _G.Settings.SelectWeapon = value
end)

-- Refresh Weapons Button
Tabs.Combat:AddButton({
    Title = "Refresh Weapons",
    Description = "Update weapon list",
    Callback = function()
        weapons = {}
        for _, tool in pairs(LocalPlayer.Backpack:GetChildren()) do
            if tool:IsA("Tool") then
                table.insert(weapons, tool.Name)
            end
        end
        WeaponDropdown:SetValues(weapons)
    end
})

-- Misc Tab
local MiscSection = Tabs.Misc:AddSection("Player Info")

local PlayerInfo = Tabs.Misc:AddParagraph({
    Title = "Player Stats",
    Content = "Level: " .. LocalPlayer.Data.Level.Value .. "\nMoney: " .. LocalPlayer.Data.Beli.Value
})

-- Update player info
spawn(function()
    while wait(5) do
        PlayerInfo:SetDesc("Level: " .. LocalPlayer.Data.Level.Value .. "\nMoney: " .. LocalPlayer.Data.Beli.Value .. "\nTarget: " .. (QuestData.MonsterName or "None"))
    end
end)

-- Character Update Handler
LocalPlayer.CharacterAdded:Connect(function(newChar)
    Character = newChar
    HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
end)

Window:SelectTab(1)

-- Load settings
SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({})
InterfaceManager:SetFolder("FluentScriptHub")
SaveManager:SetFolder("FluentScriptHub/specific-game")
InterfaceManager:BuildInterfaceSection(Tabs.Misc)
SaveManager:BuildConfigSection(Tabs.Misc)

Window:Notify({
    Title = "ENCHANTED HUB",
    Content = "Script loaded successfully! Level: " .. LocalPlayer.Data.Level.Value,
    Duration = 5
})

print("ENCHANTED HUB loaded!")
print("Current Level:", LocalPlayer.Data.Level.Value)
CheckQuest()
print("Target Monster:", QuestData.MonsterName)
