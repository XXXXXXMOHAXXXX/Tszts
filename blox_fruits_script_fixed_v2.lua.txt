-- ENCHANTED HUB V2 | BLOX FRUITS SEA 1 
-- Enhanced & Optimized by Professional Developer

if not game:IsLoaded() then 
    repeat game.Loaded:Wait()
    until game:IsLoaded() 
end

-- Anti team selection loop
repeat wait(1)
    pcall(function()
        if game:GetService("Players").LocalPlayer.PlayerGui.Main:FindFirstChild("ChooseTeam") then
            if game:GetService("Players").LocalPlayer.PlayerGui.Main.ChooseTeam.Visible == true then
                for i,v in pairs(getconnections(game:GetService("Players").LocalPlayer.PlayerGui.Main.ChooseTeam.Container.Pirates.Frame.ViewportFrame.TextButton.MouseButton1Click)) do
                    v.Function()
                end
            end
        end
    end)
until game.Players.LocalPlayer.Neutral == false

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local VirtualUser = game:GetService("VirtualUser")
local RunService = game:GetService("RunService")

-- Variables
local LocalPlayer = Players.LocalPlayer
local Character
local HumanoidRootPart

-- Anti-AFK System
local VirtualUser = game:service'VirtualUser'
game:service'Players'.LocalPlayer.Idled:connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

spawn(function()
    while wait(3) do
        game:GetService'VirtualUser':CaptureController()
    end
end)

-- Check Sea
local placeId = game.PlaceId
if placeId ~= 2753915549 then
    LocalPlayer:Kick("This script only works in Blox Fruits Sea 1!")
    return
end

-- Global Settings
getgenv().Settings = {
    SelectedWeapon = "",
    FastAttack = false,
    AutoHaki = false,
    BringMob = false,
    AutoFarmLevel = false,
    SelectedBoss = "",
    AutoKillBoss = false,
    AttackDelay = 0.05,
    SafeTeleport = true
}

-- Fast Attack Variables
_G.Fast_Delay = 0.05
getgenv().AttackEnabled = false

-- Update character references safely
local function UpdateCharacter()
    Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    if Character then
        HumanoidRootPart = Character:WaitForChild("HumanoidRootPart", 10)
    end
end

-- Initialize character
UpdateCharacter()
LocalPlayer.CharacterAdded:Connect(UpdateCharacter)

-- Utility Functions
local function Notification(title, text, duration)
    game.StarterGui:SetCore("SendNotification", {
        Title = title,
        Text = text,
        Duration = duration or 5
    })
end

-- Safe Teleport Function (prevents underwater/underground spawning)
local function SafeTeleport(targetCFrame, speed)
    if not HumanoidRootPart then UpdateCharacter() end
    speed = speed or 350
    
    -- Ensure safe Y position (above ground/water)
    local safeY = math.max(targetCFrame.Position.Y, 100)
    local safeCFrame = CFrame.new(targetCFrame.Position.X, safeY, targetCFrame.Position.Z)
    
    -- Direct teleport for close distances
    local distance = (HumanoidRootPart.Position - safeCFrame.Position).Magnitude
    if distance < 1000 then
        HumanoidRootPart.CFrame = safeCFrame
        return
    end
    
    -- Tween for long distances
    local time = distance / speed
    
    -- Cancel existing tweens
    if getgenv().currentTween then
        getgenv().currentTween:Cancel()
    end
    
    local tween = TweenService:Create(
        HumanoidRootPart,
        TweenInfo.new(time, Enum.EasingStyle.Linear),
        {CFrame = safeCFrame}
    )
    
    getgenv().currentTween = tween
    tween:Play()
    return tween
end

-- Advanced Fast Attack System
local function AdvancedFastAttack()
    if not getgenv().AttackEnabled then return end
    
    spawn(function()
        pcall(function()
            local tool = LocalPlayer.Character:FindFirstChildOfClass("Tool")
            if tool and tool:FindFirstChild("Handle") then
                tool:Activate()
            end
            
            -- Virtual user attack
            VirtualUser:CaptureController()
            VirtualUser:Button1Down(Vector2.new(851, 158))
            VirtualUser:Button1Up(Vector2.new(851, 158))
            
            -- Humanoid state attack
            local humanoid = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid:ChangeState(Enum.HumanoidStateType.Attacking)
            end
        end)
    end)
end

-- Enhanced Bring Mobs Function with proper error handling
local function BringMobs()
    if not Settings.BringMob then return end
    
    spawn(function()
        while Settings.BringMob do
            wait(0.1)
            pcall(function()
                if not HumanoidRootPart then UpdateCharacter() end
                if not HumanoidRootPart then return end
                
                for _, mob in pairs(Workspace.Enemies:GetChildren()) do
                    if mob and mob.Parent and mob:FindFirstChild("HumanoidRootPart") and mob:FindFirstChild("Humanoid") then
                        local mobHumanoid = mob:FindFirstChild("Humanoid")
                        local mobRoot = mob:FindFirstChild("HumanoidRootPart")
                        
                        if mobHumanoid and mobRoot and mobHumanoid.Health > 0 then
                            local distance = (HumanoidRootPart.Position - mobRoot.Position).Magnitude
                            if distance <= 400 then
                                -- Safely modify mob properties
                                pcall(function()
                                    mobRoot.CFrame = HumanoidRootPart.CFrame * CFrame.new(0, 0, -5)
                                    mobRoot.CanCollide = false
                                    mobHumanoid.WalkSpeed = 0
                                    mobHumanoid.JumpPower = 0
                                    mobHumanoid.PlatformStand = true
                                end)
                                
                                -- Safely modify hitbox
                                pcall(function()
                                    if mobRoot.Size ~= Vector3.new(50, 50, 50) then
                                        mobRoot.Size = Vector3.new(50, 50, 50)
                                        mobRoot.Transparency = 0.7
                                    end
                                end)
                            end
                        end
                    end
                end
            end)
        end
    end)
end

-- Quest Data with corrected positions
local QuestData = {
    [1] = {
        Name = "BanditQuest1", 
        Number = 1, 
        Monster = "Bandit", 
        Level = 5, 
        QuestPos = CFrame.new(1060.9383544922, 16.455066680908, 1547.7841796875),
        MonsterPos = CFrame.new(1038.5533447266, 41.296249389648, 1576.5098876953)
    },
    [10] = {
        Name = "JungleQuest", 
        Number = 1, 
        Monster = "Monkey", 
        Level = 14, 
        QuestPos = CFrame.new(-1601.6553955078, 36.85213470459, 153.38809204102),
        MonsterPos = CFrame.new(-1448.1446533203, 50.851993560791, 63.60718536377)
    },
    [15] = {
        Name = "JungleQuest", 
        Number = 2, 
        Monster = "Gorilla", 
        Level = 20, 
        QuestPos = CFrame.new(-1601.6553955078, 36.85213470459, 153.38809204102),
        MonsterPos = CFrame.new(-1142.6488037109, 40.462348937988, -515.39227294922)
    },
    [30] = {
        Name = "BuggyQuest1", 
        Number = 1, 
        Monster = "Pirate", 
        Level = 35, 
        QuestPos = CFrame.new(-1140.1761474609, 4.752049446106, 3827.4057617188),
        MonsterPos = CFrame.new(-1201.0881347656, 40.628940582275, 3857.5966796875)
    },
    [60] = {
        Name = "DesertQuest", 
        Number = 1, 
        Monster = "Desert Bandit", 
        Level = 60, 
        QuestPos = CFrame.new(896.51721191406, 6.4384617805481, 4390.1494140625),
        MonsterPos = CFrame.new(984.99896240234, 16.109552383423, 4417.91015625)
    },
    [75] = {
        Name = "DesertQuest", 
        Number = 2, 
        Monster = "Desert Officer", 
        Level = 70, 
        QuestPos = CFrame.new(896.51721191406, 6.4384617805481, 4390.1494140625),
        MonsterPos = CFrame.new(1547.1510009766, 14.452038764954, 4381.8002929688)
    },
    [90] = {
        Name = "SnowQuest", 
        Number = 1, 
        Monster = "Snow Bandit", 
        Level = 90, 
        QuestPos = CFrame.new(1386.8073730469, 87.272789001465, -1298.3576660156),
        MonsterPos = CFrame.new(1356.3028564453, 105.76865386963, -1328.2418212891)
    },
    [100] = {
        Name = "SnowQuest", 
        Number = 2, 
        Monster = "Snowman", 
        Level = 100, 
        QuestPos = CFrame.new(1386.8073730469, 87.272789001465, -1298.3576660156),
        MonsterPos = CFrame.new(1218.7956542969, 138.01184082031, -1488.0262451172)
    },
    [120] = {
        Name = "MarineQuest2", 
        Number = 1, 
        Monster = "Chief Petty Officer", 
        Level = 120, 
        QuestPos = CFrame.new(-5035.49609375, 28.677835464478, 4324.1840820313),
        MonsterPos = CFrame.new(-4931.1552734375, 65.793113708496, 4121.8393554688)
    },
    [150] = {
        Name = "SkyQuest", 
        Number = 1, 
        Monster = "Sky Bandit", 
        Level = 150, 
        QuestPos = CFrame.new(-4842.1372070313, 717.69543457031, -2623.0483398438),
        MonsterPos = CFrame.new(-4955.6411132813, 365.46365356445, -2908.1865234375)
    },
    [175] = {
        Name = "SkyQuest", 
        Number = 2, 
        Monster = "Dark Master", 
        Level = 175, 
        QuestPos = CFrame.new(-4842.1372070313, 717.69543457031, -2623.0483398438),
        MonsterPos = CFrame.new(-5148.1650390625, 439.04571533203, -2332.9611816406)
    },
    [190] = {
        Name = "PrisonerQuest", 
        Number = 1, 
        Monster = "Prisoner", 
        Level = 190, 
        QuestPos = CFrame.new(5308.93115, 1.65517521, 475.120514),
        MonsterPos = CFrame.new(5162.75586, 15.9961863, 489.834991)
    },
    [210] = {
        Name = "PrisonerQuest", 
        Number = 2, 
        Monster = "Dangerous Prisoner", 
        Level = 210, 
        QuestPos = CFrame.new(5308.93115, 1.65517521, 475.120514),
        MonsterPos = CFrame.new(5548.29004, 15.9952106, 645.591675)
    },
    [250] = {
        Name = "ColosseumQuest", 
        Number = 1, 
        Monster = "Toga Warrior", 
        Level = 250, 
        QuestPos = CFrame.new(-1577.7890625, 7.4151420593262, -2984.4838867188),
        MonsterPos = CFrame.new(-1872.5166015625, 49.080215454102, -2913.810546875)
    },
    [300] = {
        Name = "MagmaQuest", 
        Number = 1, 
        Monster = "Military Soldier", 
        Level = 300, 
        QuestPos = CFrame.new(-5316.1157226563, 12.262831687927, 8517.00390625),
        MonsterPos = CFrame.new(-5369.0004882813, 61.24352645874, 8556.4921875)
    },
    [325] = {
        Name = "MagmaQuest", 
        Number = 2, 
        Monster = "Military Spy", 
        Level = 325, 
        QuestPos = CFrame.new(-5316.1157226563, 12.262831687927, 8517.00390625),
        MonsterPos = CFrame.new(-5984.0532226563, 82.14656829834, 8753.326171875)
    },
    [375] = {
        Name = "FishmanQuest", 
        Number = 1, 
        Monster = "Fishman Warrior", 
        Level = 375, 
        QuestPos = CFrame.new(61122.65234375, 18.497442245483, 1569.3997802734),
        MonsterPos = CFrame.new(60844.10546875, 98.462875366211, 1298.3985595703)
    },
    [400] = {
        Name = "FishmanQuest", 
        Number = 2, 
        Monster = "Fishman Commando", 
        Level = 400, 
        QuestPos = CFrame.new(61122.65234375, 18.497442245483, 1569.3997802734),
        MonsterPos = CFrame.new(61738.3984375, 64.207321166992, 1433.8375244141)
    },
    [450] = {
        Name = "SkyExp1Quest", 
        Number = 1, 
        Monster = "God's Guard", 
        Level = 450, 
        QuestPos = CFrame.new(-4721.88867, 843.874695, -1949.96643),
        MonsterPos = CFrame.new(-4722.36279, 853.782532, -1939.90576)
    },
    [475] = {
        Name = "SkyExp1Quest", 
        Number = 2, 
        Monster = "Shanda", 
        Level = 475, 
        QuestPos = CFrame.new(-7859.09814, 5544.19043, -381.476196),
        MonsterPos = CFrame.new(-7750.50391, 5577.92236, -488.500214)
    },
    [525] = {
        Name = "SkyExp2Quest", 
        Number = 1, 
        Monster = "Royal Squad", 
        Level = 525, 
        QuestPos = CFrame.new(-7906.81592, 5634.6626, -1411.99194),
        MonsterPos = CFrame.new(-7646.66504, 5637.42529, -1421.20361)
    },
    [550] = {
        Name = "SkyExp2Quest", 
        Number = 2, 
        Monster = "Royal Soldier", 
        Level = 550, 
        QuestPos = CFrame.new(-7906.81592, 5634.6626, -1411.99194),
        MonsterPos = CFrame.new(-7943.40625, 5637.42529, -1766.35815)
    },
    [625] = {
        Name = "FountainQuest", 
        Number = 1, 
        Monster = "Galley Pirate", 
        Level = 625, 
        QuestPos = CFrame.new(5253.54834, 38.5361786, 4050.45166),
        MonsterPos = CFrame.new(5539.56641, 112.785339, 4069.04102)
    },
    [700] = {
        Name = "FountainQuest", 
        Number = 2, 
        Monster = "Galley Captain", 
        Level = 650, 
        QuestPos = CFrame.new(5253.54834, 38.5361786, 4050.45166),
        MonsterPos = CFrame.new(5533.67285, 89.4192734, 4854.56348)
    }
}

-- Get Current Quest Function
local function GetCurrentQuest()
    local level = LocalPlayer.Data.Level.Value
    local bestQuest = nil
    
    for levelReq, questInfo in pairs(QuestData) do
        if level >= levelReq then
            bestQuest = questInfo
        end
    end
    
    return bestQuest
end

-- Equip Weapon Function
local function EquipWeapon(weaponName)
    if weaponName == "" then
        -- Auto-select first available weapon
        for _, tool in pairs(LocalPlayer.Backpack:GetChildren()) do
            if tool:IsA("Tool") then
                weaponName = tool.Name
                break
            end
        end
    end
    
    if LocalPlayer.Backpack:FindFirstChild(weaponName) then
        LocalPlayer.Character.Humanoid:EquipTool(LocalPlayer.Backpack[weaponName])
        return true
    elseif LocalPlayer.Character:FindFirstChild(weaponName) then
        return true
    end
    return false
end

-- Auto Haki Function
local function AutoHaki()
    spawn(function()
        while Settings.AutoHaki do
            wait(0.1)
            pcall(function()
                if not LocalPlayer.Character:FindFirstChild("HasBuso") then
                    ReplicatedStorage.Remotes.CommF_:InvokeServer("Buso")
                end
            end)
        end
    end)
end

-- Enhanced Auto Farm Level Function with better error handling
local function AutoFarmLevel()
    spawn(function()
        while Settings.AutoFarmLevel do
            wait(0.5)
            pcall(function()
                local currentQuest = GetCurrentQuest()
                if not currentQuest then return end
                
                UpdateCharacter()
                if not HumanoidRootPart then return end
                
                -- Safely check quest status
                local hasQuest = false
                pcall(function()
                    if LocalPlayer.PlayerGui.Main.Quest.Visible then
                        local questTitle = LocalPlayer.PlayerGui.Main.Quest.Container.QuestTitle.Title.Text
                        hasQuest = string.find(questTitle, currentQuest.Monster) ~= nil
                    end
                end)
                
                if not hasQuest then
                    -- Go get the quest
                    SafeTeleport(currentQuest.QuestPos)
                    wait(1.5)
                    
                    -- Take quest safely
                    pcall(function()
                        ReplicatedStorage.Remotes.CommF_:InvokeServer("StartQuest", currentQuest.Name, currentQuest.Number)
                    end)
                    wait(1)
                else
                    -- We have the quest, go farm
                    local foundMob = false
                    
                    -- Look for nearby enemies first
                    for _, mob in pairs(Workspace.Enemies:GetChildren()) do
                        if mob and mob.Parent and mob.Name == currentQuest.Monster then
                            local mobHumanoid = mob:FindFirstChild("Humanoid")
                            local mobRoot = mob:FindFirstChild("HumanoidRootPart")
                            
                            if mobHumanoid and mobRoot and mobHumanoid.Health > 0 then
                                foundMob = true
                                
                                -- Equip weapon safely
                                pcall(function()
                                    EquipWeapon(Settings.SelectedWeapon)
                                end)
                                
                                -- Position above mob for better hit detection
                                local targetPos = mobRoot.CFrame * CFrame.new(0, 15, 0)
                                SafeTeleport(targetPos)
                                
                                -- Enable bring mobs
                                Settings.BringMob = true
                                
                                -- Attack mob loop
                                repeat
                                    wait(Settings.AttackDelay)
                                    
                                    -- Verify mob still exists
                                    if not mob or not mob.Parent or not mobHumanoid or mobHumanoid.Health <= 0 then
                                        break
                                    end
                                    
                                    -- Fast attack
                                    if Settings.FastAttack then
                                        getgenv().AttackEnabled = true
                                        AdvancedFastAttack()
                                    end
                                    
                                    -- Keep position above mob safely
                                    pcall(function()
                                        if mobRoot and mobRoot.Parent then
                                            local newPos = mobRoot.CFrame * CFrame.new(0, 15, 0)
                                            HumanoidRootPart.CFrame = newPos
                                        end
                                    end)
                                    
                                until not mob or not mob.Parent or not mobHumanoid or mobHumanoid.Health <= 0 or not Settings.AutoFarmLevel
                                
                                getgenv().AttackEnabled = false
                                Settings.BringMob = false
                                break
                            end
                        end
                    end
                    
                    if not foundMob then
                        -- No mobs found, go to spawn location
                        SafeTeleport(currentQuest.MonsterPos)
                        wait(3)
                    end
                end
            end)
        end
    end)
end

-- Boss Data
local BossData = {
    ["The Gorilla King"] = {Level = 25, Position = CFrame.new(-1223.52808, 106.27936459, -502.292664)},
    ["Bobby"] = {Level = 55, Position = CFrame.new(-1147.65173, 132.5966301, 4156.02588)},
    ["Yeti"] = {Level = 110, Position = CFrame.new(1221.7356, 238.046906, -1488.84082)},
    ["Mob Leader"] = {Level = 120, Position = CFrame.new(-2848.59399, 107.4272871, 5342.44043)},
    ["Vice Admiral"] = {Level = 130, Position = CFrame.new(-5078.45898, 199.6520691, 4402.1665)},
    ["Warden"] = {Level = 220, Position = CFrame.new(5232.5625, 105.26856995, 747.506897)},
    ["Chief Warden"] = {Level = 230, Position = CFrame.new(5232.5625, 105.26856995, 747.506897)},
    ["Swan"] = {Level = 240, Position = CFrame.new(5232.5625, 105.26856995, 747.506897)},
    ["Magma Admiral"] = {Level = 350, Position = CFrame.new(-5530.12646, 122.8769703, 8859.91309)},
    ["Fishman Lord"] = {Level = 425, Position = CFrame.new(61351.7109375, 131.0129776000977, 1113.31689453125)},
    ["Wysper"] = {Level = 500, Position = CFrame.new(-7925.48389, 5650.76074, -636.178345)},
    ["Thunder God"] = {Level = 575, Position = CFrame.new(-7748.0185546875, 5706.80615234375, -2305.898681640625)},
    ["Cyborg"] = {Level = 675, Position = CFrame.new(6041.82373046875, 152.7312507629395, 3907.5)}
}

-- Auto Boss Farm Function with improved error handling
local function AutoBossFarm()
    spawn(function()
        while Settings.AutoKillBoss do
            wait(0.5)
            pcall(function()
                if Settings.SelectedBoss == "" then return end
                
                local bossData = BossData[Settings.SelectedBoss]
                if not bossData then return end
                
                UpdateCharacter()
                if not HumanoidRootPart then return end
                
                -- Look for the boss safely
                local boss = nil
                pcall(function()
                    boss = Workspace.Enemies:FindFirstChild(Settings.SelectedBoss)
                end)
                
                if boss and boss.Parent then
                    local bossHumanoid = boss:FindFirstChild("Humanoid")
                    local bossRoot = boss:FindFirstChild("HumanoidRootPart")
                    
                    if bossHumanoid and bossRoot and bossHumanoid.Health > 0 then
                        -- Equip weapon safely
                        pcall(function()
                            EquipWeapon(Settings.SelectedWeapon)
                        end)
                        
                        -- Position above boss
                        local targetPos = bossRoot.CFrame * CFrame.new(0, 20, 0)
                        SafeTeleport(targetPos)
                        
                        -- Attack boss loop
                        repeat
                            wait(Settings.AttackDelay)
                            
                            -- Verify boss still exists
                            if not boss or not boss.Parent or not bossHumanoid or bossHumanoid.Health <= 0 then
                                break
                            end
                            
                            -- Fast attack
                            if Settings.FastAttack then
                                getgenv().AttackEnabled = true
                                AdvancedFastAttack()
                            end
                            
                            -- Keep position above boss safely
                            pcall(function()
                                if bossRoot and bossRoot.Parent then
                                    local newPos = bossRoot.CFrame * CFrame.new(0, 20, 0)
                                    HumanoidRootPart.CFrame = newPos
                                end
                            end)
                            
                        until not boss or not boss.Parent or not bossHumanoid or bossHumanoid.Health <= 0 or not Settings.AutoKillBoss
                        
                        getgenv().AttackEnabled = false
                    end
                else
                    -- Boss not found, go to spawn location
                    SafeTeleport(bossData.Position)
                    wait(5)
                end
            end)
        end
    end)
end

-- Fast Attack Loop
spawn(function()
    while wait(_G.Fast_Delay) do
        if Settings.FastAttack and getgenv().AttackEnabled then
            AdvancedFastAttack()
        end
    end
end)

-- Auto Haki Loop
spawn(function()
    while wait(0.1) do
        if Settings.AutoHaki then
            AutoHaki()
        end
    end
end)

-- Notification
Notification("ENCHANTED HUB V2", "Script loaded successfully! Enhanced with better teleportation and attack systems.", 5)

print("ENCHANTED HUB V2 - Ready to use!")
print("Use getgenv().Settings to configure:")
print("- Settings.AutoFarmLevel = true/false")
print("- Settings.FastAttack = true/false") 
print("- Settings.AutoHaki = true/false")
print("- Settings.SelectedWeapon = 'weapon_name'")
print("- Settings.AutoKillBoss = true/false")
print("- Settings.SelectedBoss = 'boss_name'")
